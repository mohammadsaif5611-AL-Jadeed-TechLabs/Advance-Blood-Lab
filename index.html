<!DOCTYPE html>
<html>
<head>
  <title>Pathology Report</title>

  <!-- ðŸ”¥ MOBILE FIX -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
 
<!-- Supabase auth + page protection script same for both git and local -->
<script type="module">
  import { protectPage, logout } from "./js/auth.js";

  document.addEventListener("DOMContentLoaded", () => {
    protectPage();

    const btn = document.getElementById("logoutBtn");
    if (btn) {
      btn.addEventListener("click", logout);
    }
  });
</script>





   <script type="module" src="./js/main.js"></script>
  <!-- <script type="module" src="js/main.js"></script> -->
</head>

<body class="bg-light">

<!-- ===== PREMIUM NAVBAR ===== -->
<nav class="premium-navbar">
  <div class="nav-container">

    <div class="nav-left">
      <!-- <span class="brand-logo">ðŸ§ª</span> -->
      <img style="width: 100px;height: 80px;" class="brand-logo" src="assets/BG.jpg" alt="">
      <span class="brand-text">Advance Blood Lab</span>
    </div>

    <div class="nav-right" id="navMenu">
      <a href="history.html" class="nav-btn history-btn">
        History
      </a>

      <button id="logoutBtn" class="nav-btn logout-btn">
        Logout
      </button>
    </div>

    <div class="nav-toggle" id="navToggle">
      <span></span>
      <span></span>
      <span></span>
    </div>

  </div>
</nav>

  

<div class="container mt-4">

  <!-- ===== SUBSCRIPTION CARD ===== -->
<div id="subscriptionCard"
     class="card border-warning mb-3 shadow-sm"
     style="display:none;">
  <div class="card-body py-2">
    <strong id="subscriptionText"></strong>
  </div>
</div>



 <!-- <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Patient Details</h4>
    <button  class="btn btn-danger btn-sm">
      <a href="history.html">History </a>
    </button>
    <button id="logoutBtn" class="btn btn-danger btn-sm">
      Logout
    </button>
  </div> -->


 <form id="patientForm" class="card p-3">

  <h5 class="mb-3">Patient Information</h5>

<label>Patient Name</label>

<!-- <div class="d-flex mb-2"> -->
  <!-- PREFIX -->
  <select class="form-control  mb-2" id="prefix" onchange="updateNameAndSex()">
    <option value="MR.">MR.</option>
    <option value="MASTER.">MASTER.</option>
    <option value="MRS." selected>MRS.</option>
    <option value="MISS.">MISS.</option>
    <option value="BABY/MISS.">BABY/MISS.</option>
    <option value="BABY/OF.">BABY/OF.</option>

  </select>

  <!-- NAME -->
 

 <input
    class="form-control mb-2"
    id="patient_name"
    placeholder="PATIENT NAME"
    value="PATIENT NAME"
    oninput="toUpperCaseInput(this)"
    required
  />


  <label>Referred By</label>
  <input
    class="form-control mb-2"
    id="ref_by"
    placeholder="REFERRED BY"
    value="DR. MUJAHID KHAN SIR"
    oninput="toUpperCaseInput(this)"
  />

  <label>Sample</label>
 
  <select class="form-control mb-2" id="sample">
  <option value="RECEIVED FROM OUTSIDE" selected>RECEIVED FROM OUTSIDE</option>
  <option value="RECEIVED FROM HOSPITAL">RECEIVED FROM HOSPITAL</option>
  <option value="COLLECTED IN LAB">COLLECTED IN LAB</option>
</select>

  <div class="row">
    <div class="col-md-6">
      <label>Age</label>
      <input
        class="form-control mb-2"
        id="age"
        inputmode="numeric"
        placeholder="AGE"
        value="22"
        oninput="onlyNumber(this)"
        required
      />
    </div>

    <div class="col-md-6">
     <label>Sex</label>
<select class="form-control mb-2" id="sex">
  <option value="Male">Male</option>
  <option value="Female" selected>Female</option>
  <option value="Other">Other</option>
</select>

    </div>
  </div>

  <label>Date</label>
  <input class="form-control mb-2" id="date" type="date" />

  <label>LRN</label>
  <input
    class="form-control mb-3"
    id="lrn"
    inputmode="numeric"
    placeholder="LRN"
    value="0590"
    oninput="onlyNumber(this)"
  />

  <h5 class="mt-3">Select Tests</h5>
  <div id="tests" class="mb-3"></div>

  <button class="btn btn-primary w-100">Next</button>
</form>

</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
<style>
  /* =====================
   MOBILE RESPONSIVE FIX
===================== */

body {
  font-size: 16px;
}

.btn-danger {
    color: #fff;
    background-color: #ff0000;
    border-color: #ff0018;
}
 .btn {
    /* font-size: 18px; */
            font-weight: 700;
    padding: 10px;
    border-radius: 7px;
  }


  /* =============================
   PREMIUM NAVBAR (Google + IG UI)
============================= */

.premium-navbar {
  background: #ffffff;
  padding: 14px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.06);
  position: sticky;
  top: 0;
  z-index: 999;
}

.nav-container {
  width: 92%;
  max-width: 1200px;
  margin: auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.nav-left {
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand-logo {
  font-size: 22px;
}

.brand-text {
  font-weight: 600;
  font-size: 18px;
  letter-spacing: 0.3px;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.nav-btn {
  border: none;
  padding: 8px 18px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  transition: 0.3s ease;
  text-decoration: none;
  cursor: pointer;
}

/* Google style soft button */
.history-btn {
  background: #f1f3f4;
  color: #202124;
}

.history-btn:hover {
  background: #e8eaed;
  transform: translateY(-1px);
}

/* Instagram style gradient logout */
.logout-btn {
  background: linear-gradient(45deg, #ff416c, #ff4b2b);
  color: #fff;
}
.logout-btn {
    background: linear-gradient(45deg, #e85d7c, #ff0000);
    color: #fff;
}

.logout-btn:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* Mobile toggle */
.nav-toggle {
  display: none;
  flex-direction: column;
  gap: 5px;
  cursor: pointer;
}

.nav-toggle span {
  width: 24px;
  height: 2px;
  background: #333;
  border-radius: 2px;
}


/* Container full width on mobile */
@media (max-width: 768px) {

  .container {
    max-width: 100% !important;
    padding-left: 12px;
    padding-right: 12px;
  }

  h4, h5 {
    font-size: 18px;
    font-weight: 600;
  }

  label {
    font-size: 14px;
    font-weight: 600;
  }

  /* Bigger inputs (IMPORTANT) */
  .form-control {
    font-size: 16px;        /* ðŸ‘ˆ mobile zoom fix */
    padding: 12px 14px;
    height: auto;
    border-radius: 10px;
  }

  select.form-control {
    appearance: auto;
  }

  /* Card look like screenshot */
  .card {
    border-radius: 16px;
    padding: 16px !important;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
  }

  /* Button big & touch friendly */
  .btn {
    font-size: 18px;
            font-weight: 700;
    padding: 10px;
    border-radius: 7px;
  }

   .nav-right {
    position: absolute;
    top: 65px;
    right: 4%;
    background: #fff;
    flex-direction: column;
    padding: 15px;
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    display: none;
    width: 200px;
  }

  .nav-right.active {
    display: flex;
  }

  .nav-btn {
    width: 100%;
    text-align: center;
  }

  .nav-toggle {
    display: flex;
  }
.card-body {
    -ms-flex: 1 1 auto;
    flex: 1 1 auto;
    min-height: 1px;
    padding: 0.25rem;
}
#subscriptionCard {
  background: linear-gradient(45deg, #fff3cd, #ffe8a1);
  border: none;
  border-radius: 14px;
}

#subscriptionText {
  font-size: 15px;
  font-weight: 600;
}

}

</style>

<script>
  const toggle = document.getElementById("navToggle");
  const menu = document.getElementById("navMenu");

  toggle.addEventListener("click", () => {
    menu.classList.toggle("active");
  });
</script>


<script>
    /* ===== FORCE UPPERCASE ===== */
 
  /* ===== NUMBER ONLY ===== */
  function onlyNumber(el) {
    el.value = el.value.replace(/[^0-9]/g, "");
  }


  function toUpperCaseInput(el) {
    el.value = el.value.toUpperCase();
  }


function updateNameAndSex() {
  const prefix = document.getElementById("prefix")?.value || "";
  const nameInput = document.getElementById("patient_name");
  const sexSelect = document.getElementById("sex");

  if (!nameInput || !sexSelect) return;

  // Remove ANY existing prefix
  let name = nameInput.value.toUpperCase();
  name = name.replace(
    /^(MR\.|MASTER\.|MRS\.|MISS\.|BABY\/MISS\.|BABY\/OF\.)\s*/g,
    ""
  );

  // Add selected prefix
  nameInput.value = `${prefix} ${name}`.trim();

  // Auto sex logic
  const malePrefixes = ["MR.", "MASTER.", "BABY/OF."];
  const femalePrefixes = ["MRS.", "MISS.", "BABY/MISS."];

  if (malePrefixes.includes(prefix)) {
    sexSelect.value = "Male";
  } else if (femalePrefixes.includes(prefix)) {
    sexSelect.value = "Female";
  }
}


  // Auto set date
  document.addEventListener("DOMContentLoaded", () => {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("date").value = today;

    // Run once on load
    updateNameAndSex();
  });
</script>
<script type="module">
  import { supabase } from "./js/supabase.js";

async function showLicenceAlert() {
  const { data: sessionData } = await supabase.auth.getSession();
  if (!sessionData.session) return;

  const userId = sessionData.session.user.id;

  const { data: licence, error } = await supabase
    .from("user_licence")
    .select("expiry_date")
    .eq("user_id", userId)
    .single();

  if (error || !licence) return;

  const expiry = new Date(licence.expiry_date);

  const card = document.getElementById("subscriptionCard");
  const text = document.getElementById("subscriptionText");

  card.style.display = "block";

  function updateCountdown() {
    const now = new Date();
    const diff = expiry - now;

    if (diff <= 0) {
      text.innerText = "âš ï¸ Subscription has expired.";
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((diff / (1000 * 60)) % 60);
    const seconds = Math.floor((diff / 1000) % 60);

    text.innerText =
      `Subscription expires in ${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  // Run immediately
  updateCountdown();

  // Update every second
  setInterval(updateCountdown, 1000);

  /* ===== LAST 3 DAYS ALERT ===== */
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const expiryDate = new Date(licence.expiry_date);
  expiryDate.setHours(0, 0, 0, 0);

  const diffMs = expiryDate - today;
  const daysLeft = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

if (daysLeft > 0 && daysLeft <= 3) {
  alert(
    `âš ï¸ Subscription expires soon in ${daysLeft} day(s).\n` +
    `Please contact Aljadeed Tech Labs.`
  );
}

}



  document.addEventListener("DOMContentLoaded", showLicenceAlert);
</script>



</html>
